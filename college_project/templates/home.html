{% extends 'layout.html' %}
{% load static %}

{% block title %}Home{% endblock %}

{% block content %}

<!-- ================= HERO SLIDER ================= -->
<section class="hero-slider">

    <div class="slide active">
        <img src="{% static 'images/slide1.png' %}" alt="">
    </div>

    <div class="slide">
        <img src="{% static 'images/slide2.png' %}" alt="">
    </div>

    <div class="slide">
        <img src="{% static 'images/slide3.png' %}" alt="">
    </div>

    <div class="arrow left">&#10094;</div>
    <div class="arrow right">&#10095;</div>

    <div class="dots"></div>

</section>


<!-- ================= CAR SLIDER ================= -->
<section class="car-slider-section">

    <h2>Avtomobillar</h2>

    <div class="car-slider-wrapper">

        <div class="car-slider">
            {% for i in "0123456789" %}

            <div class="car-card">
                <img src="{% static 'images/car1.png' %}" alt="">
                <h3>Chevrolet Captiva</h3>
                <p class="price">15 000 000 SO'M</p>
                <a href="{% url 'captiva_detail' %}">
                    <button>Batafsil</button>
                </a>

            </div>

            <div class="car-card">
                <img src="{% static 'images/car2.png' %}" alt="">
                <h3>Chevrolet Traverse</h3>
                <p class="price">80 000 000 SO'M</p>
                <a href="{% url 'traverse_detail' %}">
                    <button>Batafsil</button>

                </a>
            </div>

            <div class="car-card">
                <img src="{% static 'images/car3.png' %}" alt="">
                <h3>Chevrolet Onix</h3>
                <p class="price">15 000 000 SO'M</p>
                <a href="{% url 'onix_detail' %}">
                <button>Batafsil</button>
                </a>
            </div>



            <div class="car-card">
                <img src="{% static 'images/car4.png' %}" alt="">
                <h3>Chevrolet Tracker</h3>
                <p class="price">35 000 000 SO'M</p>
                <a href="{% url 'tracker_detail' %}">
                <button>Batafsil</button>
                </a>
            </div>
        {% endfor %}

        </div>

        <div class="car-arrow left">&#10094;</div>
        <div class="car-arrow right">&#10095;</div>



    </div>

</section>


<!-- ================= MODEL HIGHLIGHT ================= -->
<section class="model-highlight">

    <div class="model-tabs">
        <span class="active" data-model="onix">Onix</span>
        <span data-model="tracker">Tracker</span>
    </div>

    <div class="model-image">
        <img id="modelImg" src="{% static 'images/onix-big.png' %}" alt="">
    </div>

    <div class="model-info">
        <p class="model-small-text">
            Eng kutilgan yangilik. Ishlab chiqarilishidan avval xaridorlar “yoqimtoy”ga aylanib ulgurgan avtomobil.
        </p>

        <h2 id="modelTitle">Chevrolet Onix</h2>

        <p class="model-subtitle">
            Chevrolet ONIX – Barchasi u haqida
        </p>

        <div class="model-buttons">
            <button class="btn-outline" style="color:white">Batafsil</button>
            <button class="btn-filled">Onlayn xarid</button>
        </div>
    </div>

</section>

<section class="promo-grid">

    <!-- ROW 1 -->
    <div class="promo-item">
        <img src="{% static 'images/captiva/captiva-promo.png' %}" alt="Chevrolet Captiva">
    </div>

    <div class="promo-item promo-text blue">
        <div class="promo-content">
            <h2>Chevrolet Captiva</h2>
            <p class="subtitle">Har bir sayohat uchun sizning mukammal hamrohingiz!</p>
            <p>
                Chevrolet Captiva – bu kundalik qulaylik va uzoq safarlar uchun mo‘ljallangan keng,
                texnologik SUV. Jasur dizayn, ergonomik salon va zamonaviy funksiyalar
                har bir safarni oson va xavfsiz qiladi.
            </p>
            <button class="promo-btn">Batafsil</button>
        </div>
    </div>

    <!-- ROW 2 -->
    <div class="promo-item promo-text dark">
        <div class="promo-content">
            <h2>Chevrolet Equinox</h2>
            <p class="subtitle">Masofani bosib o‘tadigan ishonchlilik</p>
            <p>
                Equinox uzoq muddatli ishonchlilik va kuchli harakat tizimi bilan
                sizni har qanday manzilga olib boradi.
            </p>
            <button class="promo-btn">Batafsil</button>
        </div>
    </div>

    <div class="promo-item">
        <img src="{% static 'images/equinox-promo.png' %}" alt="Chevrolet Equinox">
    </div>

</section>



{% endblock %}



{% block scripts %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Global chat elements with safety checks
    const chatToggle = document.getElementById("chatToggle");
    const chatContainer = document.getElementById("chatContainer");
    const closeChat = document.getElementById("closeChat");
    const sendBtn = document.getElementById("sendBtn");
    const messageInput = document.getElementById("message");
    const chatMessages = document.getElementById("chatMessages");

    // Properly wrapped chat initialization
    if (chatToggle && chatContainer) {
        chatToggle.onclick = () => {
            chatContainer.classList.toggle("hidden");
        };
    }

    if (closeChat && chatContainer) {
        closeChat.onclick = () => {
            chatContainer.classList.add("hidden");
        };
    }

    if (sendBtn) {
        sendBtn.onclick = sendMessage;
    }

    if (messageInput) {
        messageInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") sendMessage();
        });
    }

    function sendMessage() {
        if (!messageInput || !chatMessages) return;

        let message = messageInput.value.trim();
        if (!message) return;

        chatMessages.innerHTML += `
        <div class="chat-message user"><b>Siz:</b> ${message}</div>
    `;

        chatMessages.innerHTML += `
        <div class="chat-message bot" id="loading">Yozilmoqda...</div>
    `;

        chatMessages.scrollTop = chatMessages.scrollHeight;

        fetch("/chat/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({ message: message })
        })
            .then(res => res.json())
            .then(data => {
                const loadingEl = document.getElementById("loading");
                if (loadingEl) loadingEl.remove();

                if (chatMessages) {
                    chatMessages.innerHTML += `
                <div class="chat-message bot"><b>AI:</b> ${data.response || "No response"}</div>
            `;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            })
            .catch(err => {
                const loadingEl = document.getElementById("loading");
                if (loadingEl) loadingEl.remove();
                console.error("Chat error:", err);
            });

        messageInput.value = "";
    }

    document.addEventListener("DOMContentLoaded", function () {

        /* ================= HERO SLIDER ================= */

        const heroSlides = document.querySelectorAll(".hero-slider .slide");
        const heroLeft = document.querySelector(".hero-slider .arrow.left");
        const heroRight = document.querySelector(".hero-slider .arrow.right");
        const dotsContainer = document.querySelector(".hero-slider .dots");

        if (heroSlides.length) {

            let heroIndex = 0;
            let heroInterval;

            if (dotsContainer) {
                heroSlides.forEach((_, i) => {
                    const dot = document.createElement("span");
                    if (i === 0) dot.classList.add("active");
                    dot.addEventListener("click", () => {
                        heroIndex = i;
                        showHero();
                        restartHero();
                    });
                    dotsContainer.appendChild(dot);
                });
            }

            const heroDots = document.querySelectorAll(".hero-slider .dots span");

            function showHero() {
                if (!heroSlides[heroIndex]) return;
                heroSlides.forEach(s => s.classList.remove("active"));
                heroSlides[heroIndex].classList.add("active");

                if (heroDots.length > heroIndex) {
                    heroDots.forEach(d => d.classList.remove("active"));
                    heroDots[heroIndex].classList.add("active");
                }
            }

            function nextHero() {
                heroIndex = (heroIndex + 1) % heroSlides.length;
                showHero();
            }

            function prevHero() {
                heroIndex = (heroIndex - 1 + heroSlides.length) % heroSlides.length;
                showHero();
            }

            function startHero() {
                heroInterval = setInterval(nextHero, 4000);
            }

            function restartHero() {
                clearInterval(heroInterval);
                startHero();
            }

            heroRight?.addEventListener("click", () => {
                nextHero();
                restartHero();
            });

            heroLeft?.addEventListener("click", () => {
                prevHero();
                restartHero();
            });

            startHero();
        }


        /* ================= CAR SLIDER ================= */

        const carSlider = document.querySelector(".car-slider");
        const carLeft = document.querySelector(".car-arrow.left");
        const carRight = document.querySelector(".car-arrow.right");

        if (carSlider) {
            const carCards = document.querySelectorAll(".car-card");
            if (carCards.length > 0) {
                const gap = 30;
                const visibleCards = 3;
                let carIndex = 0;

                function getCardWidth() {
                    return carCards[0].offsetWidth + gap;
                }

                function updateCar() {
                    const cardWidth = getCardWidth();
                    carSlider.style.transform = `translateX(-${carIndex * cardWidth}px)`;
                }

                carRight?.addEventListener("click", () => {
                    if (carIndex < carCards.length - visibleCards) {
                        carIndex++;
                    } else {
                        carIndex = 0;
                    }
                    updateCar();
                });

                carLeft?.addEventListener("click", () => {
                    if (carIndex > 0) {
                        carIndex--;
                    } else {
                        carIndex = Math.max(0, carCards.length - visibleCards);
                    }
                    updateCar();
                });

                window.addEventListener("resize", updateCar);
            }
        }


        /* ================= MODEL SWITCH ================= */

        const tabs = document.querySelectorAll(".model-tabs span");
        const modelImg = document.getElementById("modelImg");
        const modelTitle = document.getElementById("modelTitle");

        if (tabs.length && modelImg && modelTitle) {
            tabs.forEach(tab => {
                tab.addEventListener("click", function () {
                    tabs.forEach(t => t.classList.remove("active"));
                    this.classList.add("active");

                    const model = this.dataset.model;
                    if (model === "tracker") {
                        modelImg.src = "{% static 'images/tracker-big.jpg' %}";
                        modelTitle.textContent = "Chevrolet Tracker";
                    } else {
                        modelImg.src = "{% static 'images/onix-big.png' %}";
                        modelTitle.textContent = "Chevrolet Onix";
                    }
                });
            });
        }

    });
</script>
{% endblock %}